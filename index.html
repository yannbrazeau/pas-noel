<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NoÃ«l chez les Brazo â€” Le Dernier Convive (V2)</title>

<style>
:root{
  --bg1:#0b1430;
  --bg2:#1a0b1e;
  --paper:#fff7ee;
  --ink:#1b1b1b;
  --gold:#d6b25e;
  --red:#c41e3a;
  --green:#1f7a4d;
}

*{box-sizing:border-box}

body{
  margin:0;
  padding:18px;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:#fff;
  background:
    radial-gradient(900px 600px at 20% 0%, rgba(214,178,94,.20), transparent 60%),
    radial-gradient(900px 700px at 80% 10%, rgba(196,30,58,.18), transparent 55%),
    radial-gradient(1200px 900px at 50% 110%, rgba(31,122,77,.18), transparent 60%),
    linear-gradient(180deg, var(--bg1), var(--bg2));
}

.wrap{max-width:860px;margin:0 auto}

.card{
  background:var(--paper);
  color:var(--ink);
  border-radius:22px;
  padding:18px;
  box-shadow:0 18px 40px rgba(0,0,0,.35);
  border:1px solid rgba(0,0,0,.06);
  position:relative;
  margin:0 auto 16px;
}

.card:after{
  content:"";
  position:absolute;
  inset:10px;
  border-radius:16px;
  border:1px solid rgba(214,178,94,.55);
  pointer-events:none;
}

h1,h2{margin:0 0 10px}
h1{font-size:28px}
h2{font-size:18px}
.small{opacity:.78;font-size:14px;line-height:1.35}
.hr{height:1px;background:rgba(0,0,0,.10);margin:12px 0;border-radius:999px}

textarea,button{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(0,0,0,.14);
  font-size:16px;
  margin-top:10px;
  background:#fff;
  color:#111;
}

button{
  cursor:pointer;
  font-weight:900;
  border:none;
  color:#fff;
  background:linear-gradient(180deg,#2aa565,#167347);
  box-shadow:0 10px 22px rgba(31,122,77,.20);
}
button.secondary{
  background:linear-gradient(180deg,#d63a4f,#a9122b);
  box-shadow:0 10px 22px rgba(196,30,58,.18);
}
button.reset{
  background:linear-gradient(180deg,#2b4aa5,#19357a);
  box-shadow:0 10px 22px rgba(11,74,158,.18);
}

.box{
  margin-top:12px;
  padding:12px;
  border-radius:16px;
  background:rgba(0,0,0,.05);
  border:1px dashed rgba(196,30,58,.35);
}

.pill{
  display:inline-block;
  padding:6px 10px;
  border-radius:999px;
  background:rgba(214,178,94,.18);
  border:1px solid rgba(214,178,94,.45);
  font-size:13px;
  margin:6px 6px 0 0;
}

a{color:#0b4a9e;word-break:break-all}
.hide{display:none}
</style>
</head>

<body>
<div class="wrap">

<!-- ================= HOST ================= -->
<div class="card" id="host">
  <h1>ğŸ„ NoÃ«l chez les Brazo</h1>
  <h2>ğŸ•¯ï¸ Le Dernier Convive â€” V2</h2>

  <div class="small">
    1) Mets <b>exactement 9 prÃ©noms</b> (1 par ligne)<br>
    2) Clique <b>GÃ‰NÃ‰RER</b><br>
    3) Envoie Ã  chacun son lien privÃ©<br>
    4) Pendant le repas, envoie les liens <b>?a=</b> dans le groupe pour synchroniser
  </div>

  <textarea id="names" placeholder="Yann&#10;Delphine&#10;Maxime&#10;Louis&#10;Gabriel&#10;Juliette&#10;Baptiste&#10;..."></textarea>
  <button id="btnGen">GÃ‰NÃ‰RER LA PARTIE</button>

  <div class="box">
    <h2>ğŸ”— Liens privÃ©s joueurs</h2>
    <div id="links" class="small">â€”</div>
  </div>

  <div class="box">
    <h2>ğŸ“£ Liens de groupe (actes)</h2>
    <div id="actLinks" class="small">â€”</div>
  </div>

  <div class="box">
    <h2>ğŸ§© Solution (hÃ´te)</h2>
    <div id="solution" class="small">â€”</div>
  </div>
</div>

<!-- ================= PLAYER ================= -->
<div class="card hide" id="player">
  <h1>ğŸ•¯ï¸ Le Dernier Convive</h1>
  <div class="small"><b>Joueur :</b> <span id="pname"></span> â€” Ne montre pas ton Ã©cran</div>

  <div class="box">
    <h2>ğŸ­ Ton rÃ´le</h2>
    <div id="role" class="small"></div>
    <div id="roleRule" class="small"></div>
  </div>

  <div class="box hide" id="killerBox">
    <h2>ğŸ”ª Ton objectif secret</h2>
    <div id="killerGoal" class="small"></div>
  </div>

  <div class="box">
    <h2 id="actTitle"></h2>
    <div id="story" class="small"></div>
  </div>

  <div class="box">
    <h2>ğŸ” Ton indice</h2>
    <div id="clue" class="small"></div>
  </div>

  <button class="secondary" id="btnNext">ACTE SUIVANT</button>

  <!-- MODE TEST -->
  <div class="box" id="testBox">
    <h2>ğŸ§¼ Mode test</h2>
    <div class="small">
      Si tu testes plusieurs joueurs sur <b>le mÃªme tÃ©lÃ©phone</b>,
      efface le joueur enregistrÃ© ici.
    </div>
    <button class="reset" id="btnReset">EFFACER LE JOUEUR SUR CE TÃ‰LÃ‰PHONE</button>
  </div>
</div>

</div>

<script>
/* ===== Utils ===== */
function b64uEncode(o){
  const j=JSON.stringify(o);
  const b=new TextEncoder().encode(j);
  let s=""; for(const x of b)s+=String.fromCharCode(x);
  return btoa(s);
}
function b64uDecode(s){
  const b=atob(s); const a=new Uint8Array(b.length);
  for(let i=0;i<b.length;i++)a[i]=b.charCodeAt(i);
  return JSON.parse(new TextDecoder().decode(a));
}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function pick(a){return a[Math.floor(Math.random()*a.length)];}

/* ===== Game data ===== */
const ACTS=[
 ["ğŸ¥‚ ApÃ©ro","Les premiÃ¨res phrases tombent. Quelquâ€™un teste lâ€™ambiance."],
 ["ğŸ½ï¸ EntrÃ©e","Un objet nâ€™est plus exactement Ã  sa place."],
 ["ğŸ Plat","Quelquâ€™un anticipe les rÃ©actions avant quâ€™elles nâ€™arrivent."],
 ["ğŸ§€ Fromage","Un indice est trop parfait pour Ãªtre honnÃªte."],
 ["ğŸ° Dessert","La vÃ©ritÃ© est une combinaison. Accuse."]
];

const WHERE=["Cuisine","Salon","Salle Ã  manger","EntrÃ©e","Couloir","Terrasse","Escalier","PrÃ¨s du frigo","Point dâ€™eau"];
const HOW=["Message anonyme","Faux indice","Mensonge rÃ©pÃ©tÃ©","Substitution","Rumeur","Disparition dâ€™objet","Mise en scÃ¨ne"];

const ROLES=[
 {id:"observer",label:"ğŸ•µï¸ Observateur",rule:"Tu reÃ§ois un indice bonus Ã  lâ€™apÃ©ro."},
 {id:"silent",label:"ğŸ¤ Silencieux",rule:"Ã€ lâ€™apÃ©ro, tu ne peux pas parler."},
 {id:"manipulator",label:"ğŸ­ Manipulateur",rule:"Tu as un faux indice crÃ©dible."},
 {id:"confident",label:"ğŸ•¯ï¸ Confident",rule:"Une fois, tu peux montrer un indice."}
];

const KILLER_GOALS=[
 "ÃŠtre accusÃ© par au moins deux personnes",
 "Faire accuser un innocent prÃ©cis",
 "Ne jamais mentir explicitement",
 "Ne jamais Ãªtre nommÃ© avant le dessert"
];

let payload=null, act=0;

/* ===== Generate ===== */
function generate(){
  const names=document.getElementById("names").value.split("\n").map(s=>s.trim()).filter(Boolean);
  if(names.length!==9){alert("Il faut exactement 9 prÃ©noms");return;}

  const killer=pick(names), where=pick(WHERE), how=pick(HOW);
  document.getElementById("solution").innerHTML=`ğŸ”ª <b>${killer}</b><br>ğŸ“ ${where}<br>ğŸ› ï¸ ${how}`;

  const base=location.origin+location.pathname;

  document.getElementById("actLinks").innerHTML=ACTS.map((a,i)=>
    `<div class="pill">${a[0]}</div><a href="${base}?a=${i}">${base}?a=${i}</a><br>`
  ).join("");

  const roleMap={};
  names.forEach(n=>roleMap[n]={id:"detective",label:"ğŸ•¯ï¸ DÃ©tective",rule:"Recoupe les infos."});
  shuffle([...ROLES]).slice(0,4).forEach((r,i)=>roleMap[names[i]]=r);

  let links="";
  names.forEach(n=>{
    const data=b64uEncode({
      n,
      role:roleMap[n],
      killer:n===killer,
      killerGoal:n===killer?pick(KILLER_GOALS):null
    });
    links+=`<div class="pill">${n}</div><a href="${base}?p=${encodeURIComponent(data)}">${base}?p=...</a><br>`;
  });
  document.getElementById("links").innerHTML=links;
}

/* ===== Player ===== */
function renderAct(){
  document.getElementById("actTitle").textContent=ACTS[act][0];
  document.getElementById("story").textContent=ACTS[act][1];
  document.getElementById("role").textContent=payload.role.label;
  document.getElementById("roleRule").textContent=payload.role.rule;
  if(payload.killer){
    document.getElementById("killerBox").classList.remove("hide");
    document.getElementById("killerGoal").textContent=payload.killerGoal;
  }
}

function load(){
  const p=new URLSearchParams(location.search).get("p");
  const a=new URLSearchParams(location.search).get("a");

  if(p){
    localStorage.setItem("dlc_player",""+p);
    payload=b64uDecode(decodeURIComponent(p));
    document.getElementById("host").classList.add("hide");
    document.getElementById("player").classList.remove("hide");
    document.getElementById("pname").textContent=payload.n;
    if(a!==null)act=parseInt(a,10)||0;
    renderAct();
    return;
  }

  if(a!==null){
    const saved=localStorage.getItem("dlc_player");
    if(saved){
      location.replace(location.pathname+"?p="+encodeURIComponent(saved)+"&a="+a);
    }else alert("Ouvre dâ€™abord ton lien privÃ©");
  }
}

/* ===== Events ===== */
document.getElementById("btnGen").onclick=generate;
document.getElementById("btnNext").onclick=()=>{if(act<ACTS.length-1){act++;renderAct();}};
document.getElementById("btnReset").onclick=()=>{
  localStorage.removeItem("dlc_player");
  alert("Joueur effacÃ© âœ…");
  location.href=location.pathname;
};

load();
</script>
</body>
</html>
