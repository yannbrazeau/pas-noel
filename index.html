<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Le Dernier Convive â€” Cluedo de table</title>
<style>
  body{font-family:system-ui;background:#0b1020;color:#fff;margin:0;padding:16px}
  .card{max-width:780px;margin:0 auto 12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);padding:16px;border-radius:18px}
  h1,h2{margin:0 0 8px}
  .muted{opacity:.8}
  textarea,input,button,select{width:100%;padding:12px;border-radius:12px;border:none;font-size:16px;margin-top:10px}
  textarea{min-height:160px}
  button{background:#22c55e;color:#06110a;font-weight:900;cursor:pointer}
  button.secondary{background:#38bdf8;color:#04121a}
  button.danger{background:#f97316;color:#1a0b04}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .row > *{flex:1 1 220px}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);font-size:13px;margin-right:6px;margin-top:6px}
  .big{font-size:22px;font-weight:900}
  .act{font-size:18px;font-weight:900;margin-top:10px}
  .box{padding:12px;border-radius:14px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10);margin-top:10px}
  .links a{color:#9ae6ff;word-break:break-all}
  .warn{color:#ffd39a}
  .ok{color:#a7f3d0}
  .hide{display:none}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
</style>
</head>
<body>

<div class="card" id="hostView">
  <h1>ğŸ•¯ï¸ Le Dernier Convive</h1>
  <div class="muted">
    Un Cluedo narratif (peur psychologique) qui se joue pendant tout le repas.<br>
    <b>9 joueurs</b> recommandÃ©. Aucun malaise, aucun rÃ´le public, aucune Ã©limination.
  </div>

  <h2 style="margin-top:14px">ğŸ‘¥ PrÃ©noms (9 lignes)</h2>
  <textarea id="names" placeholder="1 prÃ©nom par ligne (9 lignes)&#10;Ex :&#10;Yann&#10;Delphine&#10;Maxime&#10;..."></textarea>

  <div class="row">
    <button id="gen">GÃ©nÃ©rer la partie</button>
    <button id="copyHost" class="secondary">Copier le lien hÃ´te</button>
  </div>

  <div class="box">
    <div class="big">ğŸ¬ Pitch Ã  lire (15 secondes)</div>
    <div class="muted">
      â€œPendant ce repas, il y a une enquÃªte. Chacun a des indices privÃ©s sur son tÃ©lÃ©phone.
      Ã€ chaque moment (apÃ©ro/entrÃ©e/plat/fromage/dessert), on avance dâ€™un acte.
      Au dessert, chacun fait une accusation. Je rÃ©vÃ¨le la solution.â€
    </div>
  </div>

  <div class="box">
    <div class="big">ğŸ”— Liens privÃ©s (Ã  envoyer)</div>
    <div id="links" class="links muted">GÃ©nÃ¨re dâ€™abord la partie.</div>
  </div>

  <div class="box">
    <div class="big">ğŸ§© Solution (visible uniquement cÃ´tÃ© hÃ´te)</div>
    <div id="solution" class="muted warn">GÃ©nÃ¨re la partie pour voir la solution.</div>
  </div>
</div>

<div class="card hide" id="playerView">
  <div class="big">ğŸ•¯ï¸ Le Dernier Convive</div>
  <div class="muted">Vue joueur (indices privÃ©s). Ne montre pas ton Ã©cran.</div>

  <div class="box">
    <div><b>DÃ©tective :</b> <span id="pName"></span></div>
    <div class="muted">Partie : <span id="pCode" class="mono"></span></div>
  </div>

  <div class="box">
    <div class="act" id="actTitle">ğŸ¥‚ Acte I â€” ApÃ©ro</div>
    <div id="story" class="muted"></div>
  </div>

  <div class="box">
    <div class="big">ğŸ” Ton indice (cet acte)</div>
    <div id="clueNow" class="muted"></div>
  </div>

  <div class="row">
    <button id="nextAct" class="secondary">Acte suivant</button>
    <button id="showAll" class="danger">Voir mon dossier (toutes mes cartes)</button>
  </div>

  <div class="box hide" id="allCardsBox">
    <div class="big">ğŸ“ Ton dossier (cartes dâ€™exclusion)</div>
    <div id="allCards" class="muted"></div>
    <div class="muted warn" style="margin-top:8px">Astuce : Ã©limine tout ce que tu as, puis dÃ©duis ce qui manque.</div>
  </div>

  <div class="box" id="accuseBox">
    <div class="big">ğŸ§  Accusation finale (au Dessert)</div>
    <div class="muted">Tu peux attendre le dessert pour valider.</div>
    <label class="muted">QUI</label>
    <select id="accWho"></select>
    <label class="muted">OÃ™</label>
    <select id="accWhere"></select>
    <label class="muted">AVEC QUOI</label>
    <select id="accHow"></select>
    <button id="saveAcc">Enregistrer mon accusation</button>
    <div id="accSaved" class="muted ok"></div>
  </div>
</div>

<script>
/* ==========================
   DATA (Cluedo narratif)
========================== */
const ACTS = [
  { key:"apero",   title:"ğŸ¥‚ Acte I â€” ApÃ©ro",
    story:"Une phrase revient, identique, dans deux bouches diffÃ©rentes. Comme un Ã©cho. Quelquâ€™un teste le groupeâ€¦ doucement." },
  { key:"entree",  title:"ğŸ½ï¸ Acte II â€” EntrÃ©e",
    story:"Un objet nâ€™est plus Ã  sa place. Personne nâ€™a vu le mouvement. Pourtant, il a eu lieu." },
  { key:"plat",    title:"ğŸ Acte III â€” Plat",
    story:"Quelquâ€™un anticipe les rÃ©actions avant quâ€™elles nâ€™arrivent. Une micro-seconde dâ€™avance. Comme sâ€™il lisait la piÃ¨ce." },
  { key:"fromage", title:"ğŸ§€ Acte IV â€” Fromage",
    story:"Un indice est trop parfait. Trop propre. Il a Ã©tÃ© dÃ©posÃ©. Et il pointe dans une directionâ€¦ volontairement." },
  { key:"dessert", title:"ğŸ° Acte V â€” Dessert",
    story:"DerniÃ¨re chance : la vÃ©ritÃ© est une combinaison. Ce que tu nâ€™as pas Ã©liminÃ© est probablement la rÃ©ponse." }
];

const WHERE = [
  "Cuisine","Couloir","Salon","Salle Ã  manger","Terrasse / balcon",
  "EntrÃ©e","Escalier / palier","PrÃ¨s du frigo / bar","Toilettes / point dâ€™eau"
];

const HOW = [
  "Un message anonyme",
  "Une substitution discrÃ¨te",
  "Une lumiÃ¨re/son dÃ©clenchÃ©",
  "Un mensonge rÃ©pÃ©tÃ©",
  "Un faux indice placÃ©",
  "Un regard orchestrÃ©",
  "Une rumeur soufflÃ©e",
  "Une disparition dâ€™objet",
  "Une mise en scÃ¨ne subtile"
];

/* ==========================
   UTILS
========================== */
const $ = (id)=>document.getElementById(id);

function shuffle(arr, seedStr){
  // Fisher-Yates + seed simple (dÃ©terministe)
  let a = arr.slice();
  let seed = 2166136261;
  for (let i=0;i<seedStr.length;i++){ seed ^= seedStr.charCodeAt(i); seed = Math.imul(seed, 16777619); }
  function rnd(){
    seed ^= seed << 13; seed ^= seed >>> 17; seed ^= seed << 5;
    return ((seed>>>0) / 4294967296);
  }
  for (let i=a.length-1;i>0;i--){
    const j = Math.floor(rnd()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function b64encode(obj){
  return btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
}
function b64decode(str){
  return JSON.parse(decodeURIComponent(escape(atob(str))));
}

function setSelectOptions(sel, arr){
  sel.innerHTML = "";
  arr.forEach(x=>{
    const o=document.createElement("option");
    o.value=x; o.textContent=x;
    sel.appendChild(o);
  });
}

/* ==========================
   GAME GENERATION (Host)
========================== */
function generateGame(names){
  const clean = names.map(n=>n.trim()).filter(Boolean);
  if (clean.length !== 9) throw new Error("Il faut exactement 9 prÃ©noms (9 lignes).");

  // suspects = joueurs
  const SUSPECTS = clean.slice();

  // pick solution
  const seedKey = String(Date.now()); // alÃ©atoire Ã  chaque gÃ©nÃ©ration
  const sSus = shuffle(SUSPECTS, "S"+seedKey)[0];
  const sWhere = shuffle(WHERE, "W"+seedKey)[0];
  const sHow = shuffle(HOW, "H"+seedKey)[0];

  const solution = { who:sSus, where:sWhere, how:sHow };

  // build deck of remaining cards (exclusions)
  // Card format: {type:"who"/"where"/"how", value:"..."}
  const deck = [];
  SUSPECTS.forEach(x=>{ if (x!==solution.who) deck.push({type:"who", value:x}); });
  WHERE.forEach(x=>{ if (x!==solution.where) deck.push({type:"where", value:x}); });
  HOW.forEach(x=>{ if (x!==solution.how) deck.push({type:"how", value:x}); });

  const shuffledDeck = shuffle(deck, "D"+seedKey);

  // deal round-robin
  const hands = {};
  clean.forEach(n=>hands[n]=[]);
  let idx=0;
  for (const card of shuffledDeck){
    hands[clean[idx % clean.length]].push(card);
    idx++;
  }

  // Create per-act clue schedule:
  // Each act reveals at most 1 card from the player's hand (if any remain)
  const schedules = {};
  clean.forEach(n=>{
    const hand = hands[n];
    const reveal = [];
    for (let a=0;a<ACTS.length;a++){
      reveal.push(hand[a] || null);
    }
    schedules[n] = reveal;
  });

  // A short code for display (not used for security)
  const code = String(Math.floor(1000 + Math.random()*9000));

  return { code, seedKey, suspects:SUSPECTS, where:WHERE, how:HOW, solution, hands, schedules, acts:ACTS };
}

/* ==========================
   RENDER Host links
========================== */
function renderHost(game){
  const base = new URL(window.location.href);
  base.searchParams.delete("p");

  // Host payload contains full game incl. solution
  const hostPayload = { role:"host", game };
  const hostUrl = new URL(base.toString());
  hostUrl.searchParams.set("p", b64encode(hostPayload));

  // Player links: contain only player name + their schedule + lists (no solution)
  const links = [];
  for (const player of game.suspects){
    const payload = {
      role:"player",
      code: game.code,
      player,
      suspects: game.suspects,
      where: game.where,
      how: game.how,
      acts: game.acts,
      schedule: game.schedules[player],  // per-act card reveal
      hand: game.hands[player]           // full hand (for â€œdossierâ€)
    };
    const u = new URL(base.toString());
    u.searchParams.set("p", b64encode(payload));
    links.push({ player, url:u.toString() });
  }

  // Print links
  $("links").innerHTML =
    `<div class="ok"><b>Lien hÃ´te (garde-le pour toi) :</b><br><a href="${hostUrl.toString()}">${hostUrl.toString()}</a></div>` +
    `<div style="margin-top:12px"></div>` +
    links.map(x=>`<div class="pill"><b>${x.player}</b></div><div class="muted"><a href="${x.url}">${x.url}</a></div><div style="height:10px"></div>`).join("");

  $("solution").innerHTML =
    `Solution (ne pas montrer) :<br><br>
     <b>QUI :</b> ${game.solution.who}<br>
     <b>OÃ™ :</b> ${game.solution.where}<br>
     <b>AVEC QUOI :</b> ${game.solution.how}<br><br>
     <span class="muted">RÃ©vÃ¨le au dessert. Avant, laisse le mystÃ¨re vivre.</span>`;

  // Copy host link button
  $("copyHost").onclick = async ()=>{
    try{
      await navigator.clipboard.writeText(hostUrl.toString());
      alert("Lien hÃ´te copiÃ© âœ…");
    }catch(e){
      prompt("Copie ce lien hÃ´te :", hostUrl.toString());
    }
  };
}

/* ==========================
   PLAYER VIEW
========================== */
function cardToText(card){
  if (!card) return "Pas dâ€™indice personnel pour toi Ã  cet acte. Observe, et laisse les autres parler ğŸ™‚";
  if (card.type==="who") return `âŒ Le coupable nâ€™est PAS <b>${escapeHtml(card.value)}</b>.`;
  if (card.type==="where") return `âŒ Ce nâ€™Ã©tait PAS dans <b>${escapeHtml(card.value)}</b>.`;
  if (card.type==="how") return `âŒ Ce nâ€™Ã©tait PAS par <b>${escapeHtml(card.value)}</b>.`;
  return "Indice illisible.";
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function showPlayer(payload){
  $("hostView").classList.add("hide");
  $("playerView").classList.remove("hide");

  let actIndex = 0;

  $("pName").textContent = payload.player || "Joueur";
  $("pCode").textContent = payload.code || "";

  // selects for accusation
  setSelectOptions($("accWho"), payload.suspects);
  setSelectOptions($("accWhere"), payload.where);
  setSelectOptions($("accHow"), payload.how);

  function renderAct(){
    const act = payload.acts[actIndex];
    $("actTitle").textContent = act.title;
    $("story").textContent = act.story;
    $("clueNow").innerHTML = cardToText(payload.schedule[actIndex]);

    // Dessert -> encourage accusation
    if (actIndex === payload.acts.length-1){
      $("accuseBox").classList.remove("hide");
    }
  }

  $("nextAct").onclick = ()=>{
    if (actIndex < payload.acts.length-1){
      actIndex++;
      renderAct();
    } else {
      alert("Dernier acte atteint. Fais ton accusation puis attends la rÃ©vÃ©lation de lâ€™hÃ´te ğŸ•¯ï¸");
    }
  };

  $("showAll").onclick = ()=>{
    $("allCardsBox").classList.toggle("hide");
    $("allCards").innerHTML = payload.hand.map(c=>`<div class="pill">${cardToText(c).replace(/<[^>]*>/g,"")}</div>`).join(" ");
  };

  $("saveAcc").onclick = ()=>{
    const acc = {
      who: $("accWho").value,
      where: $("accWhere").value,
      how: $("accHow").value
    };
    localStorage.setItem("cluedo_acc_"+payload.code+"_"+payload.player, JSON.stringify(acc));
    $("accSaved").textContent = `âœ… Accusation enregistrÃ©e : ${acc.who} / ${acc.where} / ${acc.how}`;
  };

  // load existing accusation
  try{
    const saved = localStorage.getItem("cluedo_acc_"+payload.code+"_"+payload.player);
    if (saved){
      const a = JSON.parse(saved);
      $("accWho").value = a.who;
      $("accWhere").value = a.where;
      $("accHow").value = a.how;
      $("accSaved").textContent = `âœ… Accusation dÃ©jÃ  enregistrÃ©e : ${a.who} / ${a.where} / ${a.how}`;
    }
  }catch(_){}

  renderAct();
}

/* ==========================
   HOST VIEW from payload
========================== */
function showHost(payload){
  // Here, we simply render links/solution already in payload
  const game = payload.game;
  // Pre-fill textarea
  $("names").value = game.suspects.join("\n");
  renderHost(game);
}

/* ==========================
   BOOT
========================== */
(function boot(){
  const p = new URL(window.location.href).searchParams.get("p");
  if (p){
    const payload = b64decode(p);
    if (payload.role === "player"){
      showPlayer(payload);
      return;
    }
    if (payload.role === "host"){
      showHost(payload);
      return;
    }
  }

  // default host generator view
  $("gen").onclick = ()=>{
    try{
      const names = $("names").value.split("\n");
      const game = generateGame(names);
      renderHost(game);
      alert("Partie gÃ©nÃ©rÃ©e âœ…\nEnvoie les liens privÃ©s aux joueurs.");
    }catch(e){
      alert("Erreur : " + e.message);
    }
  };

  $("copyHost").onclick = ()=> alert("GÃ©nÃ¨re dâ€™abord la partie ğŸ™‚");
})();
</script>

</body>
</html>
