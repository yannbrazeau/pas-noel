<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NoÃ«l chez les Brazo â€” Le Dernier Convive</title>

<style>
:root{
  --bg1:#0b1430;
  --bg2:#1a0b1e;
  --paper:#fff7ee;
  --ink:#1b1b1b;
  --gold:#d6b25e;
  --red:#c41e3a;
  --green:#1f7a4d;
}

*{box-sizing:border-box}

body{
  margin:0;
  padding:18px;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:#fff;
  background:
    radial-gradient(900px 600px at 20% 0%, rgba(214,178,94,.20), transparent 60%),
    radial-gradient(900px 700px at 80% 10%, rgba(196,30,58,.18), transparent 55%),
    radial-gradient(1200px 900px at 50% 110%, rgba(31,122,77,.18), transparent 60%),
    linear-gradient(180deg, var(--bg1), var(--bg2));
}

.wrap{max-width:860px;margin:0 auto}

.card{
  background:var(--paper);
  color:var(--ink);
  border-radius:22px;
  padding:18px;
  box-shadow:0 18px 40px rgba(0,0,0,.35);
  border:1px solid rgba(0,0,0,.06);
  position:relative;
  margin:0 auto 16px;
}

.card:after{
  content:"";
  position:absolute;
  inset:10px;
  border-radius:16px;
  border:1px solid rgba(214,178,94,.55);
  pointer-events:none;
}

h1,h2{margin:0 0 10px}
h1{font-size:28px}
h2{font-size:18px}
.small{opacity:.78;font-size:14px;line-height:1.35}

textarea,button,select{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(0,0,0,.14);
  font-size:16px;
  margin-top:10px;
  background:#fff;
  color:#111;
}

button{
  cursor:pointer;
  font-weight:900;
  border:none;
  color:#fff;
  background:linear-gradient(180deg,#2aa565,#167347);
  box-shadow:0 10px 22px rgba(31,122,77,.20);
}
button.secondary{
  background:linear-gradient(180deg,#d63a4f,#a9122b);
  box-shadow:0 10px 22px rgba(196,30,58,.18);
}

.box{
  margin-top:12px;
  padding:12px;
  border-radius:16px;
  background:rgba(0,0,0,.05);
  border:1px dashed rgba(196,30,58,.35);
}

.pill{
  display:inline-block;
  padding:6px 10px;
  border-radius:999px;
  background:rgba(214,178,94,.18);
  border:1px solid rgba(214,178,94,.45);
  font-size:13px;
  margin:6px 6px 0 0;
}

a{color:#0b4a9e;word-break:break-all}
.hide{display:none}

/* Forcer la saisie au-dessus de tout */
textarea,button,select{position:relative; z-index:5; pointer-events:auto}
</style>
</head>

<body>
<div class="wrap">

  <!-- HOST -->
  <div class="card" id="host">
    <h1>ğŸ„ NoÃ«l chez les Brazo</h1>
    <h2>ğŸ•¯ï¸ Le Dernier Convive</h2>
    <div class="small">
      1) Mets <b>exactement 9 prÃ©noms</b> (1 par ligne) <br>
      2) Clique <b>GÃ‰NÃ‰RER</b> <br>
      3) Envoie Ã  chacun son lien privÃ© (WhatsApp) <br>
      4) Ã€ chaque moment du repas, tout le monde clique â€œActe suivantâ€
    </div>

    <textarea id="names" placeholder="Yann&#10;Delphine&#10;Maxime&#10;Louis&#10;Gabriel&#10;Juliette&#10;Baptiste&#10;... (9 lignes)"></textarea>
    <button id="btnGen">GÃ‰NÃ‰RER LA PARTIE</button>

    <div class="box">
      <h2>ğŸ”— Liens privÃ©s joueurs</h2>
      <div id="links" class="small">â€”</div>
    </div>

    <div class="box">
      <h2>ğŸ§© Solution (hÃ´te)</h2>
      <div id="solution" class="small">â€”</div>
      <div class="small" style="margin-top:8px">
        Ã€ dire au groupe : <b>â€œCâ€™est un Cluedo. Vous avez des indices privÃ©s. Au dessert, vous accusez.â€</b>
      </div>
    </div>
  </div>

  <!-- PLAYER -->
  <div class="card hide" id="player">
    <h1>ğŸ•¯ï¸ Le Dernier Convive</h1>
    <div class="small"><b>DÃ©tective :</b> <span id="pname"></span> â€” Ne montre pas ton Ã©cran.</div>

    <div class="box">
      <h2 id="actTitle"></h2>
      <div id="story" class="small"></div>
    </div>

    <div class="box">
      <h2>ğŸ” Ton indice</h2>
      <div id="clue" class="small"></div>
    </div>

    <button class="secondary" id="btnNext">ACTE SUIVANT</button>
  </div>

</div>

<script>
/* Base64 UTF-8 safe (rÃ©sout les accents / â€™ / etc.) */
function b64uEncode(obj){
  const json = JSON.stringify(obj);
  const bytes = new TextEncoder().encode(json);
  let bin = "";
  for (const b of bytes) bin += String.fromCharCode(b);
  return btoa(bin);
}
function b64uDecode(str){
  const bin = atob(str);
  const bytes = new Uint8Array(bin.length);
  for (let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
  const json = new TextDecoder().decode(bytes);
  return JSON.parse(json);
}

const ACTS = [
  ["ğŸ¥‚ ApÃ©ro",   "Une phrase revient deux fois, comme un Ã©cho. Quelquâ€™un teste lâ€™ambianceâ€¦ doucement."],
  ["ğŸ½ï¸ EntrÃ©e",  "Un objet nâ€™est plus exactement Ã  sa place. Personne nâ€™a vu le mouvement."],
  ["ğŸ Plat",    "Quelquâ€™un semble anticiper les rÃ©actions avant quâ€™elles nâ€™arrivent. Une micro-seconde dâ€™avance."],
  ["ğŸ§€ Fromage", "Un indice est trop parfait. Trop propre. Il a Ã©tÃ© dÃ©posÃ© volontairement."],
  ["ğŸ° Dessert", "La vÃ©ritÃ© est une combinaison. Ce que tu nâ€™as pas Ã©liminÃ© est probablement la rÃ©ponse."]
];

const WHERE = ["Cuisine","Couloir","Salon","Salle Ã  manger","Terrasse/Balcon","EntrÃ©e","Escalier/Palier","PrÃ¨s du frigo/bar","Point dâ€™eau/WC"];
const HOW   = ["Message anonyme","Substitution discrÃ¨te","Son/LumiÃ¨re dÃ©clenchÃ©","Mensonge rÃ©pÃ©tÃ©","Faux indice placÃ©","Regard orchestrÃ©","Rumeur soufflÃ©e","Disparition dâ€™objet","Mise en scÃ¨ne subtile"];

let payload = null;
let act = 0;

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}
function cleanNames(raw){
  return raw.split("\n").map(s=>s.trim()).filter(Boolean);
}

function generate(){
  const names = cleanNames(document.getElementById("names").value);
  if (names.length !== 9){
    alert("Il faut exactement 9 prÃ©noms (9 lignes non vides).");
    return;
  }

  const killer = shuffle([...names])[0];
  const where  = shuffle([...WHERE])[0];
  const how    = shuffle([...HOW])[0];

  document.getElementById("solution").innerHTML =
    `<b>ğŸ”ª ${killer}</b><br>ğŸ“ ${where}<br>ğŸ› ï¸ ${how}<br><span class="small">Ne rÃ©vÃ¨le quâ€™au dessert.</span>`;

  // Deck d'exclusions (tout sauf la solution)
  const deck = [];
  for (const n of names) if (n !== killer) deck.push(`âŒ Ce nâ€™est pas ${n}`);
  for (const w of WHERE) if (w !== where)  deck.push(`âŒ Pas ${w}`);
  for (const h of HOW)   if (h !== how)    deck.push(`âŒ Pas ${h}`);
  shuffle(deck);

  // Base URL (Nickel pour GitHub Pages)
  const base = location.origin + location.pathname;

  let linksHTML = "";
  names.forEach((n,i)=>{
    const hand = deck.filter((_,k)=>k % 9 === i);
    const data = b64uEncode({ n, hand });
    const url  = base + "?p=" + encodeURIComponent(data);
    linksHTML += `<div class="pill">${n}</div><div><a href="${url}">${url}</a></div><br>`;
  });

  document.getElementById("links").innerHTML = linksHTML;
}

function renderAct(){
  document.getElementById("actTitle").textContent = ACTS[act][0];
  document.getElementById("story").textContent    = ACTS[act][1];
  document.getElementById("clue").textContent     = payload.hand[act] || "Pas dâ€™indice personnel Ã  cet acte. Observe ğŸ™‚";
}

function nextAct(){
  if (act < ACTS.length - 1){
    act++;
    renderAct();
  } else {
    alert("Dernier acte. Fais ton accusation finale, puis attends la rÃ©vÃ©lation de lâ€™hÃ´te ğŸ•¯ï¸");
  }
}

function loadPlayer(){
  const p = new URLSearchParams(location.search).get("p");
  if (!p) return;

  payload = b64uDecode(decodeURIComponent(p));

  document.getElementById("host").classList.add("hide");
  document.getElementById("player").classList.remove("hide");

  document.getElementById("pname").textContent = payload.n;
  renderAct();
}

document.getElementById("btnGen").addEventListener("click", generate);
document.getElementById("btnNext").addEventListener("click", nextAct);

loadPlayer();
</script>
</body>
</html>
